#!/usr/bin/env python
import sys
import os
import json
import subprocess



# The common methods need to move to a common package
# These also have to be inlined so that you can copy
# only that file and all dependencies are in the same.
# Didn't find a good way to do that
#def fail_json(output):
#    exit_json = {}
#    exit_json['msg'] = output['msg']
#    exit_json['status'] = 'failure'
#    print json.dumps(exit_json)
#
#def exit_json(output):
#    print json.dumps(output)
#

# Params for this module
# package: package name that will be installed via yum
# loglevel: if debug, it shows you the entire output as part of 'output' key
def is_installed(name):
    command = ["yum","list","installed"] + name.split()
    p = subprocess.Popen(command, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    output, err = p.communicate()
    if "No matching Packages" in err:
        return False
    else:
        return True

params = json.loads(sys.stdin.read())
result = {}
possible_states = ["absent", "present", "latest"]
try:
    name = params.get('name')
    state = params.get('state')
    # check if state provided is valid
    valid_state = [s for s in possible_states if state == s]
    if valid_state == []:
        raise Exception("Valid states are one of %s " % ','.join(possible_states))

    # check if package is already installed
    installed = is_installed(name)
    command = ""
    if installed:
        if state == "absent":
            command = ["yum", "remove", "-y"] + name.split()
        else:
            result['msg'] = "Package %s already present" % name
            result['status'] = "ok"
    else:
        if state == "present" or state == "latest":
            command = ["yum", "install", "-y"] + name.split()
        else:
            result['msg'] = "Package %s absent" % name
            result['status'] = "ok"
    if command != "":
        p = subprocess.Popen(command, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        output, err = p.communicate()
        if err or p.returncode > 0:
            raise Exception(err)
        else:
            result['status'] = "changed"
            result['msg'] = "State of package %s changed" % name
            result['output'] = output
except Exception, e:
    result['status'] = "error"
    result['msg'] = "Error occurred while installing package %s" % url
    result['output'] = str(e)

print json.dumps(result)
